<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapToEarn Admin - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #00d4ff;
        }
        .success { background: rgba(0, 255, 0, 0.1); border-color: #00ff00; }
        .error { background: rgba(255, 0, 0, 0.1); border-color: #ff0000; }
        .warning { background: rgba(255, 165, 0, 0.1); border-color: #ffa500; }
        button {
            background: #00d4ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0099cc;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ TapToEarn Admin Panel - Debug Mode</h1>
        
        <div class="status">
            <h3>üîß Debug Information</h3>
            <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
            <p><strong>User Agent:</strong> <span id="userAgent"></span></p>
            <p><strong>Telegram WebApp:</strong> <span id="telegramStatus"></span></p>
        </div>

        <div class="status">
            <h3>üì° Connection Tests</h3>
            <button onclick="testSupabaseLibrary()">Test Supabase Library</button>
            <button onclick="testDatabaseConnection()">Test Database Connection</button>
            <button onclick="testUserTable()">Test Users Table</button>
            <button onclick="clearLogs()">Clear Logs</button>
        </div>

        <div id="logContainer">
            <!-- Logs will appear here -->
        </div>
    </div>

    <!-- Load Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    
    <!-- Load Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        // Configuration - REPLACE WITH YOUR ACTUAL VALUES
        const SUPABASE_URL = 'https://arjkzpbhinpqensoqqod.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyamt6cGJoaW5wcWVuc29xcW9kIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTA2MDAxNSwiZXhwIjoyMDcwNjM2MDE1fQ.dwT80IaEOwk8Gz6qwHD1eZeu6trTCW8krqD0YaAssQU';
        
        let supabase = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Page loaded successfully', 'success');
            
            // Display basic info
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 100) + '...';
            
            // Check Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                document.getElementById('telegramStatus').textContent = '‚úÖ Available';
                log('üì± Telegram WebApp detected', 'success');
            } else {
                document.getElementById('telegramStatus').textContent = '‚ùå Not available (normal for browser)';
                log('‚ö†Ô∏è Telegram WebApp not detected (running in browser)', 'warning');
            }
        });

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `
                <strong>[${new Date().toLocaleTimeString()}]</strong> ${message}
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('üßπ Logs cleared', 'success');
        }

        function testSupabaseLibrary() {
            log('üîç Testing Supabase library...', 'info');
            
            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Supabase library not loaded');
                }
                
                log('‚úÖ Supabase library loaded successfully', 'success');
                
                // Try to create client
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
                    auth: {
                        autoRefreshToken: false,
                        persistSession: false
                    }
                });
                
                if (supabase) {
                    log('‚úÖ Supabase client created successfully', 'success');
                } else {
                    throw new Error('Failed to create Supabase client');
                }
                
            } catch (error) {
                log(`‚ùå Supabase library test failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseConnection() {
            if (!supabase) {
                log('‚ùå Please test Supabase library first', 'error');
                return;
            }
            
            log('üîó Testing database connection...', 'info');
            
            try {
                // Simple connection test
                const { data, error } = await supabase
                    .from('users')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log('‚ö†Ô∏è Connected to database but "users" table does not exist', 'warning');
                        log('üí° You need to run the SQL schema commands in Supabase', 'warning');
                    } else if (error.message.includes('relation "public.users" does not exist')) {
                        log('‚ö†Ô∏è Users table does not exist in database', 'warning');
                        log('üí° Run the SQL schema I provided in your Supabase SQL editor', 'warning');
                    } else {
                        throw error;
                    }
                } else {
                    log('‚úÖ Database connection successful!', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Database connection failed: ${error.message}`, 'error');
                log(`üîß Error code: ${error.code || 'N/A'}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('üí° This might be a network/CORS issue', 'warning');
                }
            }
        }

        async function testUserTable() {
            if (!supabase) {
                log('‚ùå Please test Supabase library first', 'error');
                return;
            }
            
            log('üë• Testing users table...', 'info');
            
            try {
                const { data, error, count } = await supabase
                    .from('users')
                    .select('telegram_id, username, created_at', { count: 'exact' })
                    .limit(5);
                
                if (error) {
                    throw error;
                }
                
                log(`‚úÖ Users table exists with ${count || 0} records`, 'success');
                
                if (data && data.length > 0) {
                    log(`üìã Sample users:`, 'info');
                    data.forEach(user => {
                        log(`  ‚Ä¢ ID: ${user.telegram_id}, Username: ${user.username || 'N/A'}`, 'info');
                    });
                } else {
                    log('üì≠ No users found in table (this is normal for new setup)', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Users table test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run basic tests when page loads
        setTimeout(() => {
            testSupabaseLibrary();
        }, 1000);
    </script>
</body>
</html>
