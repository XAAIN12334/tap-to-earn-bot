<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tap to Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .admin-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .admin-subtitle {
            opacity: 0.8;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .admin-sections {
            display: grid;
            gap: 30px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .user-table th,
        .user-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 2px;
            transition: all 0.3s ease;
            font-size: 11px;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-success {
            background: #2ed573;
            color: white;
        }
        
        .btn-primary {
            background: #3742fa;
            color: white;
        }

        .btn-warning {
            background: #ffa726;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-input, .form-select {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1;
            min-width: 150px;
        }

        .form-select option {
            background: #2a5298;
            color: white;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .withdrawal-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #ffa726;
        }
        
        .package-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .package-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .access-denied {
            text-align: center;
            padding: 50px 20px;
        }
        
        .access-denied h1 {
            font-size: 48px;
            color: #ff4757;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid #2ed573;
            color: #2ed573;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .package-assignment-section {
            background: rgba(255, 167, 38, 0.1);
            border: 1px solid rgba(255, 167, 38, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>Loading Admin Panel...</h2>
            <p>Connecting to database...</p>
        </div>

        <!-- Access Denied -->
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h1>üö´</h1>
            <h2>Access Denied</h2>
            <p>You don't have admin privileges to access this panel.</p>
            <p>Contact the administrator if you believe this is an error.</p>
        </div>

        <!-- Database Error -->
        <div id="databaseError" class="access-denied" style="display: none;">
            <h1>‚ö†Ô∏è</h1>
            <h2>Database Connection Error</h2>
            <p>Please configure your Supabase credentials.</p>
            <div class="error-message" id="errorDetails"></div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-container" style="display: none;">
            <div class="header">
                <div class="admin-title">üéØ Admin Control Panel</div>
                <div class="admin-subtitle">Connected to Supabase Database</div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTaps">0</div>
                    <div class="stat-label">Total Taps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activePackages">0</div>
                    <div class="stat-label">Active Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingWithdrawals">0</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalReferrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
            </div>

            <!-- User Management -->
            <div class="section">
                <div class="section-title">üë• User Management</div>
                
                <!-- Package Assignment Section -->
                <div class="package-assignment-section">
                    <h4 style="color: #ffa726; margin-bottom: 15px;">üì¶ Assign Package to User</h4>
                    <div class="input-group">
                        <input type="number" class="form-input" id="packageUserIdInput" placeholder="Telegram User ID">
                        <select class="form-select" id="packageSelect">
                            <option value="">Select Package</option>
                        </select>
                        <button class="btn btn-warning" onclick="assignPackageToUser()">üéÅ Assign Package</button>
                    </div>
                    <p style="font-size: 12px; opacity: 0.7; margin-top: 10px;">
                        ‚ö†Ô∏è Use this feature to manually assign packages to users if the auto-checking system fails.
                    </p>
                </div>
                
                <div class="input-group">
                    <input type="text" class="form-input" id="searchUser" placeholder="Search by username or Telegram ID">
                    <button class="btn btn-primary" onclick="searchUsers()">üîç Search</button>
                    <button class="btn btn-success" onclick="loadAllUsers()">üìã Show All Users</button>
                </div>

                <div class="input-group">
                    <input type="number" class="form-input" id="userIdInput" placeholder="Telegram User ID">
                    <input type="number" class="form-input" id="coinsToAdd" placeholder="Coins to add" step="0.01">
                    <button class="btn btn-success" onclick="addCoins()">üí∞ Add Coins</button>
                    <button class="btn btn-danger" onclick="toggleUserBan()">üö´ Ban/Unban User</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="user-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>Total Taps</th>
                                <th>Level</th>
                                <th>Referrals</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 20px;">
                                    Click "Show All Users" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Withdrawal Management -->
            <div class="section">
                <div class="section-title">üí≥ Withdrawal Management</div>
                
                <div id="withdrawalsList">
                    <p style="text-align: center; opacity: 0.7;">Click "Refresh Withdrawals" to load data</p>
                </div>

                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadPendingWithdrawals()">üîÑ Refresh Withdrawals</button>
                    <button class="btn btn-success" onclick="approveAllWithdrawals()">‚úÖ Approve All</button>
                </div>
            </div>

            <!-- Package Configuration -->
            <div class="section">
                <div class="section-title">üì¶ Package Configuration</div>
                
                <div class="package-config" id="packageConfig">
                    <p style="text-align: center; opacity: 0.7;">Loading packages...</p>
                </div>

                <div class="input-group">
                    <input type="text" class="form-input" id="newPackageName" placeholder="Package Name">
                    <input type="number" class="form-input" id="newPackagePrice" placeholder="Price ($)" step="0.01">
                    <input type="number" class="form-input" id="newPackageProfit" placeholder="Max Profit ($)" step="0.01">
                    <input type="number" class="form-input" id="newPackageTapLimit" placeholder="Daily Tap Limit">
                    <button class="btn btn-success" onclick="addNewPackage()">‚ûï Add Package</button>
                </div>
            </div>

            <!-- Database Status -->
            <div class="section">
                <div class="section-title">üìä Database Status</div>
                <div id="databaseStatus">
                    <p>üîÑ Checking connection...</p>
                </div>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="testConnection()">üß™ Test Connection</button>
                    <button class="btn btn-success" onclick="refreshAllData()">üîÑ Refresh All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• CONFIGURATION - REPLACE WITH YOUR CREDENTIALS
        const SUPABASE_URL = 'https://arjkzpbhinpqensoqqod.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyamt6cGJoaW5wcWVuc29xcW9kIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTA2MDAxNSwiZXhwIjoyMDcwNjM2MDE1fQ.dwT80IaEOwk8Gz6qwHD1eZeu6trTCW8krqD0YaAssQU';
        const ADMIN_TELEGRAM_ID = 6733587823; // Your Telegram ID
        
        // Initialize Supabase client with proper service role configuration
        let supabase;
        let isSupabaseConnected = false;
        
        // Initialize Telegram Web App
        const tg = window.Telegram?.WebApp;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupabase();
            
            if (tg) {
                tg.ready();
                checkAdminAccess();
            } else {
                // For testing without Telegram
                setTimeout(checkAdminAccess, 1000);
            }
        });

        function initializeSupabase() {
            try {
                if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_SERVICE_KEY === 'YOUR_SUPABASE_SERVICE_KEY_HERE') {
                    throw new Error('Supabase credentials not configured');
                }
                
                // FIXED: Proper service role configuration
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
                    auth: {
                        autoRefreshToken: false,
                        persistSession: false
                    },
                    global: {
                        headers: {
                            'apikey': SUPABASE_SERVICE_KEY,
                            'Authorization': `Bearer ${SUPABASE_SERVICE_KEY}`
                        }
                    },
                    db: {
                        schema: 'public'
                    }
                });
                
                isSupabaseConnected = true;
                console.log('‚úÖ Supabase connected successfully with service role');
                
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                showDatabaseError(error.message);
            }
        }

        function showDatabaseError(error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('databaseError').style.display = 'block';
            document.getElementById('errorDetails').textContent = error;
        }

        function checkAdminAccess() {
            const loading = document.getElementById('loading');
            const accessDenied = document.getElementById('accessDenied');
            const adminPanel = document.getElementById('adminPanel');

            if (!isSupabaseConnected) {
                return; // Database error already shown
            }

            try {
                // Get user data from Telegram
                const telegramUser = tg?.initDataUnsafe?.user;
                
                // üîß For testing - set to false in production
                const isAdmin = true; // Change to: telegramUser && telegramUser.id === ADMIN_TELEGRAM_ID

                console.log('Admin check:', {
                    telegramUser,
                    telegramUserId: telegramUser?.id,
                    adminId: ADMIN_TELEGRAM_ID,
                    isAdmin
                });

                setTimeout(() => {
                    loading.style.display = 'none';
                    
                    if (isAdmin) {
                        adminPanel.style.display = 'block';
                        loadAdminData().catch(error => {
                            console.error('Failed to load admin data:', error);
                            showMessage('Some admin data failed to load. Check console for details.', 'error');
                        });
                    } else {
                        accessDenied.style.display = 'block';
                    }
                }, 1500);
            } catch (error) {
                console.error('Error in checkAdminAccess:', error);
                loading.style.display = 'none';
                accessDenied.style.display = 'block';
            }
        }

        async function loadAdminData() {
            try {
                showMessage('Loading admin data...', 'info');
                
                const promises = [
                    loadStats().catch(err => console.warn('Stats loading failed:', err)),
                    loadPackageConfig().catch(err => console.warn('Package config loading failed:', err)),
                    loadPackageSelect().catch(err => console.warn('Package select loading failed:', err)),
                    testConnection().catch(err => console.warn('Connection test failed:', err))
                ];
                
                await Promise.allSettled(promises);
                showMessage('‚úÖ Admin data loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                showMessage('Some admin features may not work properly. Check database connection.', 'error');
            }
        }

        async function loadStats() {
            try {
                // FIXED: Better error handling and queries
                const [usersResult, packagesResult, withdrawalsResult] = await Promise.allSettled([
                    supabase.from('app_users').select('*'),
                    supabase.from('user_packages').select(`*, packages(price)`),
                    supabase.from('withdrawals').select('*')
                ]);

                // Get users data
                const users = usersResult.status === 'fulfilled' ? usersResult.value.data || [] : [];
                
                // Get packages data
                const packages = packagesResult.status === 'fulfilled' ? packagesResult.value.data || [] : [];
                
                // Get withdrawals data
                const withdrawals = withdrawalsResult.status === 'fulfilled' ? withdrawalsResult.value.data || [] : [];

                // Update stats
                document.getElementById('totalUsers').textContent = users.length;
                
                const totalRevenue = packages.reduce((sum, pkg) => sum + (pkg.packages?.price || 0), 0);
                document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
                
                const totalTaps = users.reduce((sum, user) => sum + (user.total_taps || 0), 0);
                document.getElementById('totalTaps').textContent = totalTaps.toLocaleString();
                
                const activePackages = packages.filter(pkg => pkg.is_active).length;
                document.getElementById('activePackages').textContent = activePackages;
                
                const pendingWithdrawals = withdrawals.filter(w => w.status === 'pending').length;
                document.getElementById('pendingWithdrawals').textContent = pendingWithdrawals;
                
                const totalReferrals = users.reduce((sum, user) => sum + (user.referral_count || 0), 0);
                document.getElementById('totalReferrals').textContent = totalReferrals;

            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Failed to load statistics: ' + error.message, 'error');
            }
        }

        async function loadPackageSelect() {
            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('price', { ascending: true });
                
                if (error) throw error;

                const select = document.getElementById('packageSelect');
                select.innerHTML = '<option value="">Select Package</option>';
                
                (packages || []).forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.id;
                    option.textContent = `${pkg.name} - $${parseFloat(pkg.price).toFixed(2)}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading package select:', error);
                showMessage('Failed to load packages for selection', 'error');
            }
        }

        async function assignPackageToUser() {
            try {
                const userId = document.getElementById('packageUserIdInput').value.trim();
                const packageId = document.getElementById('packageSelect').value;
                
                if (!userId || !packageId) {
                    showMessage('Please enter User ID and select a package!', 'error');
                    return;
                }

                showMessage('Assigning package...', 'info');

                // FIXED: Check if user exists first, create if not
                let { data: user, error: getUserError } = await supabase
                    .from('app_users')
                    .select('telegram_id, username')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError) {
                    if (getUserError.code === 'PGRST116') {
                        // User doesn't exist, create them
                        const { error: createUserError } = await supabase
                            .from('app_users')
                            .insert({
                                telegram_id: parseInt(userId),
                                username: `user_${userId}`,
                                balance: 0,
                                total_taps: 0,
                                energy: 100,
                                max_energy: 100,
                                level: 1,
                                created_at: new Date().toISOString()
                            });

                        if (createUserError) throw createUserError;
                        
                        user = { telegram_id: parseInt(userId), username: `user_${userId}` };
                        showMessage('User created automatically', 'success');
                    } else {
                        throw getUserError;
                    }
                }

                // Get package details
                const { data: packageData, error: getPackageError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (getPackageError || !packageData) {
                    throw new Error('Package not found');
                }

                // Check if user already has this package active
                const { data: existingPackage, error: checkError } = await supabase
                    .from('user_packages')
                    .select('*')
                    .eq('user_id', parseInt(userId))
                    .eq('package_id', packageId)
                    .eq('is_active', true);

                if (checkError) throw checkError;

                if (existingPackage && existingPackage.length > 0) {
                    showMessage('User already has this package active!', 'error');
                    return;
                }

                // Calculate expiry date
                const purchaseDate = new Date();
                const expiryDate = new Date(purchaseDate);
                expiryDate.setDate(expiryDate.getDate() + (packageData.duration_days || 30));

                // FIXED: Assign package with proper data types
                const { error: assignError } = await supabase
                    .from('user_packages')
                    .insert({
                        user_id: parseInt(userId),
                        package_id: parseInt(packageId),
                        purchase_date: purchaseDate.toISOString(),
                        expiry_date: expiryDate.toISOString(),
                        is_active: true,
                        remaining_profit: parseFloat(packageData.max_profit),
                    });

                if (assignError) throw assignError;

                // Log admin action
                await supabase
                    .from('admin_logs')
                    .insert({
                        admin_telegram_id: ADMIN_TELEGRAM_ID,
                        action: 'assign_package',
                        target_user_id: parseInt(userId),
                        details: {
                            package_id: packageId,
                            package_name: packageData.name,
                            package_price: packageData.price,
                            assigned_manually: true
                        }
                    });

                showMessage(`‚úÖ Package "${packageData.name}" assigned to ${user.username || userId}!`, 'success');
                
                // Clear inputs
                document.getElementById('packageUserIdInput').value = '';
                document.getElementById('packageSelect').value = '';
                
                // Refresh stats
                await loadStats();
                
            } catch (error) {
                console.error('Error assigning package:', error);
                showMessage('Failed to assign package: ' + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                showMessage('Loading users...', 'info');
                
                const { data: users, error } = await supabase
                    .from('app_users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                displayUsers(users || []);
                showMessage('‚úÖ Users loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Failed to load users: ' + error.message, 'error');
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No users found</td></tr>';
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.telegram_id}</td>
                    <td>${user.username || 'N/A'}</td>
                    <td>$${parseFloat(user.balance || 0).toFixed(2)}</td>
                    <td>${user.total_taps || 0}</td>
                    <td>${user.level || 1}</td>
                    <td>${user.referral_count || 0}</td>
                    <td><span style="color: ${user.is_banned ? '#ff4757' : '#2ed573'}">${user.is_banned ? 'BANNED' : 'ACTIVE'}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewUserDetails(${user.telegram_id})">üëÅÔ∏è</button>
                        <button class="btn btn-${user.is_banned ? 'success' : 'danger'}" onclick="toggleUserBan(${user.telegram_id})">
                            ${user.is_banned ? '‚úÖ' : 'üö´'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function searchUsers() {
            try {
                const searchTerm = document.getElementById('searchUser').value.trim();
                
                if (!searchTerm) {
                    await loadAllUsers();
                    return;
                }

                showMessage('Searching users...', 'info');
                
                const { data: users, error } = await supabase
                    .from('app_users')
                    .select('*')
                    .or(`username.ilike.%${searchTerm}%,telegram_id.eq.${searchTerm}`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                displayUsers(users || []);
                showMessage(`Found ${users?.length || 0} users`, 'success');
                
            } catch (error) {
                console.error('Error searching users:', error);
                showMessage('Search failed: ' + error.message, 'error');
            }
        }

        async function addCoins() {
            try {
                const userId = document.getElementById('userIdInput').value.trim();
                const coinsToAdd = parseFloat(document.getElementById('coinsToAdd').value);
                
                if (!userId || !coinsToAdd || coinsToAdd <= 0) {
                    showMessage('Please enter valid User ID and positive amount!', 'error');
                    return;
                }

                showMessage('Adding coins...', 'info');

                // FIXED: Get current balance with better error handling
                let { data: user, error: getUserError } = await supabase
                    .from('app_users')
                    .select('balance, username')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError) {
                    if (getUserError.code === 'PGRST116') {
                        // User doesn't exist, create them first
                        const { error: createUserError } = await supabase
                            .from('app_users')
                            .insert({
                                telegram_id: parseInt(userId),
                                username: `user_${userId}`,
                                balance: coinsToAdd,
                                total_taps: 0,
                                energy: 100,
                                max_energy: 100,
                                level: 1,
                            });

                        if (createUserError) throw createUserError;
                        
                        showMessage(`‚úÖ User created and ${coinsToAdd} coins added!`, 'success');
                        
                        // Clear inputs
                        document.getElementById('userIdInput').value = '';
                        document.getElementById('coinsToAdd').value = '';
                        
                        return;
                    } else {
                        throw getUserError;
                    }
                }

                // Update balance
                const newBalance = parseFloat(user.balance || 0) + coinsToAdd;
                
                const { error: updateError } = await supabase
                    .from('app_users')
                    .update({ 
                        balance: newBalance,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                // Log the transaction
               // .from('transactions')
                // .insert({
                 //     user_id: parseInt(userId),
               //     type: 'admin_add',
               //     amount: coinsToAdd,
               //     description: `Admin added ${coinsToAdd} coins`,
               //     created_at: new Date().toISOString()
               // });
                // Log admin action
// await supabase
//     .from('admin_logs')
//     .insert({
//         admin_telegram_id: ADMIN_TELEGRAM_ID,
//         action: 'add_coins',
//         target_user_id: parseInt(userId),
//         details: {
//             amount: coinsToAdd,
//             old_balance: user.balance,
//             new_balance: newBalance
//         }
//     });
                
                // Clear inputs
                document.getElementById('userIdInput').value = '';
                document.getElementById('coinsToAdd').value = '';
                
                // Refresh user list if visible
                const tbody = document.getElementById('usersTableBody');
                if (tbody.children.length > 1) {
                    await loadAllUsers();
                }
                
            } catch (error) {
                console.error('Error adding coins:', error);
                showMessage('Failed to add coins: ' + error.message, 'error');
            }
        }

        async function toggleUserBan(userTelegramId = null) {
            try {
                const userId = userTelegramId || document.getElementById('userIdInput').value.trim();
                
                if (!userId) {
                    showMessage('Please enter User ID!', 'error');
                    return;
                }

                showMessage('Updating user status...', 'info');

                // Get current user status
                const { data: user, error: getUserError } = await supabase
                    .from('app_users')
                    .select('is_banned, username')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError) {
                    throw new Error('User not found');
                }

                const newStatus = !user.is_banned;
                
                // Update user status
                const { error: updateError } = await supabase
                    .from('app_users')
                    .update({ 
                        is_banned: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                // Log admin action
                await supabase
                    .from('admin_logs')
                    .insert({
                        admin_telegram_id: ADMIN_TELEGRAM_ID,
                        action: newStatus ? 'ban_user' : 'unban_user',
                        target_user_id: parseInt(userId),
                        details: {
                            previous_status: user.is_banned,
                            new_status: newStatus
                        }
                    });

                showMessage(`‚úÖ User ${user.username || userId} has been ${newStatus ? 'banned' : 'unbanned'}!`, 'success');
                
                // Clear input if used
                if (!userTelegramId) {
                    document.getElementById('userIdInput').value = '';
                }
                
                // Refresh user list if visible
                const tbody = document.getElementById('usersTableBody');
                if (tbody.children.length > 1) {
                    await loadAllUsers();
                }
                
            } catch (error) {
                console.error('Error toggling user ban:', error);
                showMessage('Failed to update user status: ' + error.message, 'error');
            }
        }

        async function loadPendingWithdrawals() {
            try {
                showMessage('Loading withdrawals...', 'info');
                
                const { data: withdrawals, error } = await supabase
                    .from('withdrawals')
                    .select(`
                        *,
                        app_users!withdrawals_user_id_fkey (username)
                    `)
                    .eq('status', 'pending')
                    .order('request_date', { ascending: false });
                
                if (error) throw error;

                displayWithdrawals(withdrawals || []);
                showMessage('‚úÖ Withdrawals loaded successfully!', 'success');
                
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                showMessage('Failed to load withdrawals: ' + error.message, 'error');
            }
        }

        function displayWithdrawals(withdrawals) {
            const container = document.getElementById('withdrawalsList');
            container.innerHTML = '';

            if (withdrawals.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No pending withdrawals</p>';
                return;
            }

            withdrawals.forEach(withdrawal => {
                const card = document.createElement('div');
                card.className = 'withdrawal-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong>${withdrawal.users?.username || 'Unknown'}</strong> (ID: ${withdrawal.user_id})<br>
                            Amount: <strong>$${parseFloat(withdrawal.amount).toFixed(2)}</strong><br>
                            Wallet: <code style="word-break: break-all;">${withdrawal.wallet_address}</code><br>
                            <small>Requested: ${new Date(withdrawal.request_date).toLocaleString()}</small>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="approveWithdrawal(${withdrawal.id})">‚úÖ Approve</button>
                            <button class="btn btn-danger" onclick="rejectWithdrawal(${withdrawal.id})">‚ùå Reject</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function approveWithdrawal(withdrawalId) {
            try {
                if (!confirm('Are you sure you want to approve this withdrawal?')) return;

                showMessage('Approving withdrawal...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString()
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                showMessage('‚úÖ Withdrawal approved successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showMessage('Failed to approve withdrawal: ' + error.message, 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            try {
                const reason = prompt('Reason for rejection (optional):') || 'No reason provided';
                
                if (!confirm('Are you sure you want to reject this withdrawal?')) return;

                showMessage('Rejecting withdrawal...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'rejected',
                        processed_date: new Date().toISOString(),
                        admin_notes: reason
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                showMessage('‚ùå Withdrawal rejected successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showMessage('Failed to reject withdrawal: ' + error.message, 'error');
            }
        }

        async function approveAllWithdrawals() {
            try {
                if (!confirm('Are you sure you want to approve ALL pending withdrawals?')) return;

                showMessage('Approving all withdrawals...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString()
                    })
                    .eq('status', 'pending');

                if (error) throw error;

                showMessage('‚úÖ All withdrawals approved!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error approving all withdrawals:', error);
                showMessage('Failed to approve withdrawals: ' + error.message, 'error');
            }
        }

        async function loadPackageConfig() {
            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .order('price', { ascending: true });
                
                if (error) throw error;

                displayPackages(packages || []);
                
            } catch (error) {
                console.error('Error loading packages:', error);
                showMessage('Failed to load packages: ' + error.message, 'error');
            }
        }

        function displayPackages(packages) {
            const container = document.getElementById('packageConfig');
            container.innerHTML = '';

            if (packages.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No packages found</p>';
                return;
            }

            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.className = 'package-card';
                card.innerHTML = `
                    <h4>${pkg.name}</h4>
                    <p><strong>Price:</strong> $${parseFloat(pkg.price).toFixed(2)}</p>
                    <p><strong>Max Profit:</strong> $${parseFloat(pkg.max_profit).toFixed(2)}</p>
                    <p><strong>Duration:</strong> ${pkg.duration_days || 30} days</p>
                    <p><strong>Daily Tap Limit:</strong> ${pkg.daily_tap_limit}</p>
                    <p><strong>Status:</strong> <span style="color: ${pkg.is_active ? '#2ed573' : '#ff4757'}">${pkg.is_active ? 'Active' : 'Inactive'}</span></p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="editPackage(${pkg.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-${pkg.is_active ? 'danger' : 'success'}" onclick="togglePackage(${pkg.id})">
                            ${pkg.is_active ? 'üö´ Disable' : '‚úÖ Enable'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addNewPackage() {
            try {
                const name = document.getElementById('newPackageName').value.trim();
                const price = parseFloat(document.getElementById('newPackagePrice').value);
                const profit = parseFloat(document.getElementById('newPackageProfit').value);
                const tapLimit = parseInt(document.getElementById('newPackageTapLimit').value);

                if (!name || !price || !profit || !tapLimit) {
                    showMessage('Please fill in all package details!', 'error');
                    return;
                }

                if (price <= 0 || profit <= 0 || tapLimit <= 0) {
                    showMessage('All values must be positive!', 'error');
                    return;
                }

                showMessage('Creating package...', 'info');

                const { error } = await supabase
                    .from('packages')
                    .insert({
                        name: name,
                        price: price,
                        max_profit: profit,
                        daily_tap_limit: tapLimit,
                        duration_days: 30,
                        is_active: true,
                        created_at: new Date().toISOString()
                    });

                if (error) throw error;

                showMessage(`‚úÖ Package "${name}" created successfully!`, 'success');
                
                // Clear inputs
                document.getElementById('newPackageName').value = '';
                document.getElementById('newPackagePrice').value = '';
                document.getElementById('newPackageProfit').value = '';
                document.getElementById('newPackageTapLimit').value = '';
                
                await loadPackageConfig();
                await loadPackageSelect();
                
            } catch (error) {
                console.error('Error creating package:', error);
                showMessage('Failed to create package: ' + error.message, 'error');
            }
        }

        async function togglePackage(packageId) {
            try {
                // Get current package status
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('is_active, name')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                const newStatus = !pkg.is_active;
                
                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        is_active: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                showMessage(`‚úÖ Package "${pkg.name}" ${newStatus ? 'enabled' : 'disabled'}!`, 'success');
                await loadPackageConfig();
                await loadPackageSelect();
                
            } catch (error) {
                console.error('Error toggling package:', error);
                showMessage('Failed to update package: ' + error.message, 'error');
            }
        }

        async function editPackage(packageId) {
            try {
                // Get current package data
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                const newName = prompt(`Enter new name for ${pkg.name}:`, pkg.name);
                if (!newName || newName.trim() === '') return;

                const newPrice = prompt(`Enter new price for ${pkg.name}:`, pkg.price);
                if (!newPrice || parseFloat(newPrice) <= 0) return;

                const newProfit = prompt(`Enter new max profit for ${pkg.name}:`, pkg.max_profit);
                if (!newProfit || parseFloat(newProfit) <= 0) return;

                const newTapLimit = prompt(`Enter new daily tap limit for ${pkg.name}:`, pkg.daily_tap_limit);
                if (!newTapLimit || parseInt(newTapLimit) <= 0) return;

                showMessage('Updating package...', 'info');

                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        name: newName.trim(),
                        price: parseFloat(newPrice),
                        max_profit: parseFloat(newProfit),
                        daily_tap_limit: parseInt(newTapLimit),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                showMessage(`‚úÖ Package updated successfully!`, 'success');
                await loadPackageConfig();
                await loadPackageSelect();
                
            } catch (error) {
                console.error('Error editing package:', error);
                showMessage('Failed to edit package: ' + error.message, 'error');
            }
        }

        // FIXED: Better connection test
        async function testConnection() {
            try {
                showMessage('Testing connection...', 'info');
                
                // Simple connection test
                const { data, error } = await supabase
                    .from('app_users')
                    .select ('telegram_id')
                    .limit(1);
                if (error) {
                    if (error.code === 'PGRST116') {

            // Table doesn't exist, create a basic structure
                document.getElementById('databaseStatus').innerHTML = `
                    <p style="color: #ffa726;">‚ö†Ô∏è Database connected but tables may not exist!</p>
                    <p><small>Connection test completed at ${new Date().toLocaleString()}</small></p>
                    <p><small>Please run the database setup SQL script first.</small></p>
                `;
                return;
            }
            throw error;
        }
        
        document.getElementById('databaseStatus').innerHTML = `
            <p style="color: #2ed573;">‚úÖ Database connected successfully!</p>
            <p><small>Connection test completed at ${new Date().toLocaleString()}</small></p>
            <p><small>Found ${data?.[0]?.count || 0} users in database.</small></p>
        `;
        
        showMessage('‚úÖ Database connection successful!', 'success');
        
    } catch (error) {
        console.error('Connection test failed:', error);
        document.getElementById('databaseStatus').innerHTML = `
            <p style="color: #ff4757;">‚ùå Database connection failed!</p>
            <p><small>Error: ${error.message}</small></p>
            <p><small>Code: ${error.code || 'Unknown'}</small></p>
        `;
        
        showMessage('Database connection failed: ' + error.message, 'error');
        
        // Show database error screen if connection completely fails
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            showDatabaseError('Network connection failed. Please check your internet connection.');
        }
    }
}

async function refreshAllData() {
    try {
        showMessage('Refreshing all data...', 'info');
        await loadAdminData();
        showMessage('‚úÖ All data refreshed successfully!', 'success');
    } catch (error) {
        console.error('Error refreshing data:', error);
        showMessage('Failed to refresh data: ' + error.message, 'error');
    }
}

async function viewUserDetails(userId) {
    try {
        const { data: user, error } = await supabase
            .from('app_users')
            .select(`
                *,
                user_packages!user_packages_user_id_fkey (
                    *,
                    packages (name, price)
                )
            `)
            .eq('telegram_id', userId)
            .single();
        
        if (error || !user) throw new Error('User not found');

        const activePackages = user.user_packages?.filter(up => up.is_active) || [];
        const totalInvested = user.user_packages?.reduce((sum, up) => sum + (up.packages?.price || 0), 0) || 0;

        const details = `
üë§ User Details:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Telegram ID: ${user.telegram_id}
Username: ${user.username || 'N/A'}
Name: ${user.first_name || ''} ${user.last_name || ''}
Balance: $${parseFloat(user.balance || 0).toFixed(2)}
Total Taps: ${user.total_taps || 0}
Energy: ${user.energy || 0}/${user.max_energy || 0}
Level: ${user.level || 1}
Total Invested: $${totalInvested.toFixed(2)}
Active Packages: ${activePackages.length}
Referrals: ${user.referral_count || 0}
Wallet: ${user.wallet_address || 'Not set'}
Status: ${user.is_banned ? 'BANNED' : 'ACTIVE'}
Joined: ${new Date(user.created_at).toLocaleString()}
Last Active: ${new Date(user.last_active || user.created_at).toLocaleString()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        `.trim();
        
        alert(details);
        
    } catch (error) {
        console.error('Error getting user details:', error);
        showMessage('Failed to load user details: ' + error.message, 'error');
    }
}

// Helper function to show messages
function showMessage(message, type = 'success') {
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'success' ? 'success-message' : (type === 'error' ? 'error-message' : 'success-message');
    messageDiv.textContent = message;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
        max-width: 300px;
    `;
    
    // Override color for info messages
    if (type === 'info') {
        messageDiv.style.background = 'rgba(0, 212, 255, 0.2)';
        messageDiv.style.border = '1px solid #00d4ff';
        messageDiv.style.color = '#00d4ff';
    }
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 3000);
}

// Add CSS animation for messages
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
    </script>
</body>
</html>
