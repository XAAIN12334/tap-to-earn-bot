<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tap to Earn</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .admin-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .admin-subtitle {
            opacity: 0.8;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            opacity: 0.8;
            font-size: 14px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #00d4ff;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        
        .user-table th,
        .user-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .user-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 3px;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-success {
            background: #2ed573;
            color: white;
        }
        
        .btn-primary {
            background: #3742fa;
            color: white;
        }
        
        .btn-warning {
            background: #ffa726;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .form-input, .form-select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1;
            min-width: 150px;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-select option {
            background: #2a5298;
            color: white;
        }
        
        .package-assignment-box {
            background: rgba(255, 213, 115, 0.1);
            border: 2px solid #ffd573;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .package-assignment-title {
            color: #ffd573;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .withdrawal-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #ffa726;
        }
        
        .package-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 15px;
        }
        
        .access-denied {
            text-align: center;
            padding: 50px 20px;
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            color: #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid #2ed573;
            color: #2ed573;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .info-message {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .broadcast-section {
            margin-top: 20px;
        }

        .broadcast-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            resize: vertical;
            font-family: inherit;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>Loading Admin Panel...</h2>
            <p>Connecting to database...</p>
        </div>

        <!-- Access Denied -->
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h1>üö´</h1>
            <h2>Access Denied</h2>
            <p>You don't have admin privileges to access this panel.</p>
            <p>Contact the administrator if you believe this is an error.</p>
        </div>

        <!-- Database Error -->
        <div id="databaseError" class="access-denied" style="display: none;">
            <h1>‚ö†Ô∏è</h1>
            <h2>Database Connection Error</h2>
            <p>Please check your Supabase configuration.</p>
            <div class="error-message" id="errorDetails"></div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-container" style="display: none;">
            <div class="header">
                <div class="admin-title">üéØ Admin Control Panel</div>
                <div class="admin-subtitle">TapToEarn Management System</div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTaps">0</div>
                    <div class="stat-label">Total Taps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activePackages">0</div>
                    <div class="stat-label">Active Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingWithdrawals">0</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalReferrals">0</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
            </div>

            <!-- User Management -->
            <div class="section">
                <div class="section-title">üë• User Management</div>
                
                <div class="input-group">
                    <input type="text" class="form-input" id="searchUser" placeholder="Search by username or Telegram ID">
                    <button class="btn btn-primary" onclick="searchUsers()">üîç Search</button>
                    <button class="btn btn-success" onclick="loadAllUsers()">üìã Show All Users</button>
                </div>

                <div class="input-group">
                    <input type="number" class="form-input" id="userIdInput" placeholder="Telegram User ID">
                    <input type="number" class="form-input" id="coinsToAdd" placeholder="Points to add" step="0.01">
                    <button class="btn btn-success" onclick="addCoins()">üí∞ Add Points</button>
                    <button class="btn btn-danger" onclick="toggleUserBan()">üö´ Ban/Unban User</button>
                </div>

                <!-- Manual Package Assignment -->
                <div class="package-assignment-box">
                    <div class="package-assignment-title">üì¶ Manual Package Assignment</div>
                    <div class="input-group">
                        <input type="number" class="form-input" id="packageUserId" placeholder="Telegram User ID">
                        <select class="form-select" id="packageSelect">
                            <option value="">Select Package...</option>
                        </select>
                        <input type="number" class="form-input" id="customDuration" placeholder="Duration (days)" value="30">
                        <button class="btn btn-${user.is_banned ? 'success' : 'danger'}" onclick="toggleUserBan(${user.telegram_id})">
                            ${user.is_banned ? '‚úÖ' : 'üö´'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function quickAssignPackage(userId) {
            document.getElementById('packageUserId').value = userId;
            document.getElementById('packageSelect').focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showMessage('User ID filled! Select package above and click "Assign Package"', 'info');
        }

        async function searchUsers() {
            try {
                const searchTerm = document.getElementById('searchUser').value.trim();
                
                if (!searchTerm) {
                    await loadAllUsers();
                    return;
                }

                showMessage('Searching users...', 'info');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select(`
                        *,
                        user_packages!user_packages_user_id_fkey (
                            is_active,
                            packages (name)
                        )
                    `)
                    .or(`username.ilike.%${searchTerm}%,telegram_id.eq.${searchTerm}`)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                displayUsers(users || []);
                showMessage(`Found ${users?.length || 0} users`, 'success');
                
            } catch (error) {
                console.error('Error searching users:', error);
                showMessage('Search failed: ' + error.message, 'error');
            }
        }

        async function addCoins() {
            try {
                const userId = document.getElementById('userIdInput').value;
                const pointsToAdd = parseFloat(document.getElementById('coinsToAdd').value);
                
                if (!userId || !pointsToAdd || pointsToAdd <= 0) {
                    showMessage('Please enter valid User ID and positive amount!', 'error');
                    return;
                }

                showMessage('Adding points...', 'info');

                // Get current balance
                const { data: user, error: getUserError } = await supabase
                    .from('users')
                    .select('balance, username')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError || !user) {
                    throw new Error('User not found');
                }

                // Update balance
                const newBalance = parseFloat(user.balance || 0) + pointsToAdd;
                
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        balance: newBalance,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                // Log the transaction
                await supabase
                    .from('transactions')
                    .insert({
                        user_id: userId,
                        type: 'admin_add',
                        amount: pointsToAdd,
                        description: `Admin added ${pointsToAdd} points`
                    });

                showMessage(`‚úÖ Added ${pointsToAdd} points to ${user.username || userId}!`, 'success');
                
                // Clear inputs
                document.getElementById('userIdInput').value = '';
                document.getElementById('coinsToAdd').value = '';
                
                // Refresh stats
                await loadStats();
                
            } catch (error) {
                console.error('Error adding points:', error);
                showMessage('Failed to add points: ' + error.message, 'error');
            }
        }

        async function toggleUserBan(userTelegramId = null) {
            try {
                const userId = userTelegramId || document.getElementById('userIdInput').value;
                
                if (!userId) {
                    showMessage('Please enter User ID!', 'error');
                    return;
                }

                showMessage('Updating user status...', 'info');

                // Get current user status
                const { data: user, error: getUserError } = await supabase
                    .from('users')
                    .select('is_banned, username')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError || !user) {
                    throw new Error('User not found');
                }

                const newStatus = !user.is_banned;
                
                // Update user status
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        is_banned: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                showMessage(`‚úÖ User ${user.username || userId} has been ${newStatus ? 'banned' : 'unbanned'}!`, 'success');
                
                // Clear input if used
                if (!userTelegramId) {
                    document.getElementById('userIdInput').value = '';
                }
                
                // Refresh user list if displayed
                const tableBody = document.getElementById('usersTableBody');
                if (tableBody.children.length > 1) {
                    await loadAllUsers();
                }
                
            } catch (error) {
                console.error('Error toggling user ban:', error);
                showMessage('Failed to update user status: ' + error.message, 'error');
            }
        }

        // BROADCAST MESSAGES - New feature!
        async function sendBroadcast() {
            try {
                const message = document.getElementById('broadcastMessage').value.trim();
                
                if (!message) {
                    showMessage('Please enter a message to broadcast!', 'error');
                    return;
                }

                if (!confirm('Are you sure you want to send this message to ALL users?')) {
                    return;
                }

                showMessage('Sending broadcast message...', 'info');

                // Get all users
                const { data: users, error } = await supabase
                    .from('users')
                    .select('telegram_id')
                    .eq('is_banned', false);

                if (error) throw error;

                let successCount = 0;
                let failCount = 0;

                // Send message to each user
                for (const user of users) {
                    try {
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: user.telegram_id,
                                text: `üì¢ Admin Announcement:\n\n${message}`,
                                parse_mode: 'HTML'
                            })
                        });
                        successCount++;
                    } catch (err) {
                        failCount++;
                        console.error(`Failed to send to ${user.telegram_id}:`, err);
                    }
                }

                showMessage(`‚úÖ Broadcast sent! Success: ${successCount}, Failed: ${failCount}`, 'success');
                document.getElementById('broadcastMessage').value = '';

            } catch (error) {
                console.error('Error sending broadcast:', error);
                showMessage('Failed to send broadcast: ' + error.message, 'error');
            }
        }

        async function sendToActiveUsers() {
            try {
                const message = document.getElementById('broadcastMessage').value.trim();
                
                if (!message) {
                    showMessage('Please enter a message to broadcast!', 'error');
                    return;
                }

                if (!confirm('Send this message to users with active packages only?')) {
                    return;
                }

                showMessage('Sending to active users...', 'info');

                // Get users with active packages
                const { data: activeUsers, error } = await supabase
                    .from('users')
                    .select(`
                        telegram_id,
                        user_packages!user_packages_user_id_fkey (
                            is_active
                        )
                    `)
                    .eq('is_banned', false);

                if (error) throw error;

                const usersWithActivePackages = activeUsers.filter(user => 
                    user.user_packages?.some(pkg => pkg.is_active)
                );

                let successCount = 0;
                let failCount = 0;

                for (const user of usersWithActivePackages) {
                    try {
                        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                chat_id: user.telegram_id,
                                text: `üéØ Message for Active Members:\n\n${message}`,
                                parse_mode: 'HTML'
                            })
                        });
                        successCount++;
                    } catch (err) {
                        failCount++;
                    }
                }

                showMessage(`‚úÖ Sent to active users! Success: ${successCount}, Failed: ${failCount}`, 'success');
                document.getElementById('broadcastMessage').value = '';

            } catch (error) {
                console.error('Error sending to active users:', error);
                showMessage('Failed to send messages: ' + error.message, 'error');
            }
        }

        async function loadPendingWithdrawals() {
            try {
                showMessage('Loading withdrawals...', 'info');
                
                const { data: withdrawals, error } = await supabase
                    .from('withdrawals')
                    .select(`
                        *,
                        users!withdrawals_user_id_fkey (username)
                    `)
                    .eq('status', 'pending')
                    .order('request_date', { ascending: false });
                
                if (error) throw error;

                displayWithdrawals(withdrawals || []);
                
            } catch (error) {
                console.error('Error loading withdrawals:', error);
                showMessage('Failed to load withdrawals: ' + error.message, 'error');
            }
        }

        function displayWithdrawals(withdrawals) {
            const container = document.getElementById('withdrawalsList');
            container.innerHTML = '';

            if (withdrawals.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No pending withdrawals</p>';
                return;
            }

            withdrawals.forEach(withdrawal => {
                const card = document.createElement('div');
                card.className = 'withdrawal-card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <strong>${withdrawal.users?.username || 'Unknown'}</strong> (ID: ${withdrawal.user_id})<br>
                            Amount: <strong>${parseFloat(withdrawal.amount).toFixed(4)} TON</strong><br>
                            USD Value: <strong>${parseFloat(withdrawal.usd_amount || 0).toFixed(2)}</strong><br>
                            Wallet: <code style="word-break: break-all;">${withdrawal.wallet_address}</code><br>
                            <small>Requested: ${new Date(withdrawal.request_date).toLocaleString()}</small>
                        </div>
                        <div>
                            <button class="btn btn-success" onclick="approveWithdrawal(${withdrawal.id})">‚úÖ Approve</button>
                            <button class="btn btn-danger" onclick="rejectWithdrawal(${withdrawal.id})">‚ùå Reject</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function approveWithdrawal(withdrawalId) {
            try {
                if (!confirm('Are you sure you want to approve this withdrawal?')) return;

                showMessage('Approving withdrawal...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString()
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                showMessage('‚úÖ Withdrawal approved successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showMessage('Failed to approve withdrawal: ' + error.message, 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            try {
                const reason = prompt('Reason for rejection (optional):');
                
                if (!confirm('Are you sure you want to reject this withdrawal?')) return;

                showMessage('Rejecting withdrawal...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'rejected',
                        processed_date: new Date().toISOString(),
                        admin_notes: reason
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                showMessage('‚ùå Withdrawal rejected successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showMessage('Failed to reject withdrawal: ' + error.message, 'error');
            }
        }

        async function approveAllWithdrawals() {
            try {
                if (!confirm('Are you sure you want to approve ALL pending withdrawals?')) return;

                showMessage('Approving all withdrawals...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString()
                    })
                    .eq('status', 'pending');

                if (error) throw error;

                showMessage('‚úÖ All withdrawals approved!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error approving all withdrawals:', error);
                showMessage('Failed to approve withdrawals: ' + error.message, 'error');
            }
        }

        async function rejectAllWithdrawals() {
            try {
                const reason = prompt('Reason for rejecting all withdrawals:');
                if (!reason) return;
                
                if (!confirm('Are you sure you want to reject ALL pending withdrawals?')) return;

                showMessage('Rejecting all withdrawals...', 'info');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'rejected',
                        processed_date: new Date().toISOString(),
                        admin_notes: reason
                    })
                    .eq('status', 'pending');

                if (error) throw error;

                showMessage('‚ùå All withdrawals rejected!', 'success');
                await loadPendingWithdrawals();
                await loadStats();
                
            } catch (error) {
                console.error('Error rejecting all withdrawals:', error);
                showMessage('Failed to reject withdrawals: ' + error.message, 'error');
            }
        }

        async function loadPackageConfig() {
            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .order('price', { ascending: true });
                
                if (error) throw error;

                displayPackages(packages || []);
                
            } catch (error) {
                console.error('Error loading packages:', error);
                showMessage('Failed to load packages: ' + error.message, 'error');
            }
        }

        function displayPackages(packages) {
            const container = document.getElementById('packageConfig');
            container.innerHTML = '';

            if (packages.length === 0) {
                container.innerHTML = '<p style="text-align: center; opacity: 0.7;">No packages found</p>';
                return;
            }

            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.className = 'package-card';
                card.innerHTML = `
                    <h4>${pkg.name}</h4>
                    <p><strong>Price:</strong> ${parseFloat(pkg.price).toFixed(2)}</p>
                    <p><strong>Max Profit:</strong> ${parseFloat(pkg.max_profit).toFixed(2)}</p>
                    <p><strong>Points per Tap:</strong> ${pkg.tap_value || 0.05}</p>
                    <p><strong>Duration:</strong> ${pkg.duration_days} days</p>
                    <p><strong>Daily Tap Limit:</strong> ${pkg.daily_tap_limit}</p>
                    <p><strong>Status:</strong> <span style="color: ${pkg.is_active ? '#2ed573' : '#ff4757'}">${pkg.is_active ? 'Active' : 'Inactive'}</span></p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="editPackage(${pkg.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-${pkg.is_active ? 'danger' : 'success'}" onclick="togglePackage(${pkg.id})">
                            ${pkg.is_active ? 'üö´ Disable' : '‚úÖ Enable'}
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addNewPackage() {
            try {
                const name = document.getElementById('newPackageName').value.trim();
                const price = parseFloat(document.getElementById('newPackagePrice').value);
                const profit = parseFloat(document.getElementById('newPackageProfit').value);
                const tapLimit = parseInt(document.getElementById('newPackageTapLimit').value);
                const tapValue = parseFloat(document.getElementById('newPackageTapValue').value) || 0.05;

                if (!name || !price || !profit || !tapLimit) {
                    showMessage('Please fill in all package details!', 'error');
                    return;
                }

                showMessage('Creating package...', 'info');

                const { error } = await supabase
                    .from('packages')
                    .insert({
                        name: name,
                        price: price,
                        max_profit: profit,
                        daily_tap_limit: tapLimit,
                        tap_value: tapValue,
                        duration_days: 30,
                        is_active: true
                    });

                if (error) throw error;

                showMessage(`‚úÖ Package "${name}" created successfully!`, 'success');
                
                // Clear inputs
                document.getElementById('newPackageName').value = '';
                document.getElementById('newPackagePrice').value = '';
                document.getElementById('newPackageProfit').value = '';
                document.getElementById('newPackageTapLimit').value = '';
                document.getElementById('newPackageTapValue').value = '';
                
                await loadPackageConfig();
                await loadPackageDropdown();
                
            } catch (error) {
                console.error('Error creating package:', error);
                showMessage('Failed to create package: ' + error.message, 'error');
            }
        }

        async function togglePackage(packageId) {
            try {
                // Get current package status
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('is_active, name')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                const newStatus = !pkg.is_active;
                
                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        is_active: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                showMessage(`‚úÖ Package "${pkg.name}" ${newStatus ? 'enabled' : 'disabled'}!`, 'success');
                await loadPackageConfig();
                await loadPackageDropdown();
                
            } catch (error) {
                console.error('Error toggling package:', error);
                showMessage('Failed to update package: ' + error.message, 'error');
            }
        }

        async function editPackage(packageId) {
            try {
                // Get current package data
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                const newName = prompt(`Enter new name for ${pkg.name}:`, pkg.name);
                if (!newName) return;

                const newPrice = prompt(`Enter new price for ${pkg.name}:`, pkg.price);
                if (!newPrice) return;

                const newProfit = prompt(`Enter new max profit for ${pkg.name}:`, pkg.max_profit);
                if (!newProfit) return;

                const newTapValue = prompt(`Enter new points per tap for ${pkg.name}:`, pkg.tap_value || 0.05);
                if (!newTapValue) return;

                const newTapLimit = prompt(`Enter new daily tap limit for ${pkg.name}:`, pkg.daily_tap_limit);
                if (!newTapLimit) return;

                showMessage('Updating package...', 'info');

                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        name: newName,
                        price: parseFloat(newPrice),
                        max_profit: parseFloat(newProfit),
                        tap_value: parseFloat(newTapValue),
                        daily_tap_limit: parseInt(newTapLimit),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                showMessage(`‚úÖ Package updated successfully!`, 'success');
                await loadPackageConfig();
                await loadPackageDropdown();
                
            } catch (error) {
                console.error('Error editing package:', error);
                showMessage('Failed to edit package: ' + error.message, 'error');
            }
        }

        // FIXED: Proper connection test
        async function testConnection() {
            try {
                // Simple connection test that works with Supabase
                const { data, error } = await supabase
                    .from('users')
                    .select('telegram_id')
                    .limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows found" which is fine
                    throw error;
                }
                
                document.getElementById('databaseStatus').innerHTML = `
                    <p style="color: #2ed573;">‚úÖ Database connected successfully!</p>
                    <p><small>Connection test completed at ${new Date().toLocaleString()}</small></p>
                    <p><small>Supabase URL: ${SUPABASE_URL}</small></p>
                `;
                
            } catch (error) {
                console.error('Connection test failed:', error);
                document.getElementById('databaseStatus').innerHTML = `
                    <p style="color: #ff4757;">‚ùå Database connection failed!</p>
                    <p><small>Error: ${error.message}</small></p>
                    <p><small>Please check your Supabase credentials</small></p>
                `;
            }
        }

        async function refreshAllData() {
            showMessage('Refreshing all data...', 'info');
            await loadAdminData();
            showMessage('‚úÖ All data refreshed!', 'success');
        }

        async function cleanupDatabase() {
            try {
                if (!confirm('This will clean up expired packages and old logs. Continue?')) return;

                showMessage('Cleaning up database...', 'info');

                // Deactivate expired packages
                const { error: expiredError } = await supabase
                    .from('user_packages')
                    .update({ is_active: false })
                    .lt('expiration_date', new Date().toISOString())
                    .eq('is_active', true);

                if (expiredError) throw expiredError;

                // Delete old admin logs (older than 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

                const { error: logsError } = await supabase
                    .from('admin_logs')
                    .delete()
                    .lt('created_at', thirtyDaysAgo.toISOString());

                if (logsError) throw logsError;

                showMessage('‚úÖ Database cleanup completed!', 'success');
                await loadStats();

            } catch (error) {
                console.error('Error cleaning up database:', error);
                showMessage('Database cleanup failed: ' + error.message, 'error');
            }
        }

        async function viewUserDetails(userId) {
            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select(`
                        *,
                        user_packages!user_packages_user_id_fkey (
                            *,
                            packages (name, price)
                        )
                    `)
                    .eq('telegram_id', userId)
                    .single();
                
                if (error || !user) throw new Error('User not found');

                const activePackages = user.user_packages?.filter(up => up.is_active) || [];
                const totalInvested = user.user_packages?.reduce((sum, up) => sum + (up.packages?.price || 0), 0) || 0;

                const details = `
üë§ User Details:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Telegram ID: ${user.telegram_id}
Username: ${user.username || 'N/A'}
Name: ${user.first_name || ''} ${user.last_name || ''}
Balance: ${parseFloat(user.balance || 0).toFixed(2)} points
Total Taps: ${user.total_taps || 0}
Energy: ${user.energy || 0}/${user.max_energy || 0}
Level: ${user.level || 1}
Total Invested: ${totalInvested.toFixed(2)}
Active Packages: ${activePackages.length}
Referrals: ${user.referral_count || 0}
Wallet: ${user.wallet_address || 'Not set'}
Status: ${user.is_banned ? 'BANNED' : 'ACTIVE'}
Joined: ${new Date(user.created_at).toLocaleString()}
Last Active: ${user.last_active ? new Date(user.last_active).toLocaleString() : 'Never'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                `.trim();
                
                alert(details);
                
            } catch (error) {
                console.error('Error getting user details:', error);
                showMessage('Failed to load user details: ' + error.message, 'error');
            }
        }

        // Helper function to show messages
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 
                                  type === 'error' ? 'error-message' : 'info-message';
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                font-weight: bold;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 4000);
        }

        // Add CSS animation for messages
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>btn btn-warning" onclick="assignPackageToUser()">üéÅ Assign Package</button>
                    </div>
                    <small style="opacity: 0.7;">Assign packages to users without payment verification. Default duration is 30 days.</small>
                </div>

                <div style="overflow-x: auto;">
                    <table class="user-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Telegram ID</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>Total Taps</th>
                                <th>Level</th>
                                <th>Referrals</th>
                                <th>Active Package</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 20px;">
                                    Click "Show All Users" to load data
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Broadcast Messages -->
            <div class="section">
                <div class="section-title">üì¢ Broadcast Messages</div>
                
                <div class="broadcast-section">
                    <textarea class="broadcast-textarea" id="broadcastMessage" placeholder="Type your message to send to all users..."></textarea>
                    <div class="input-group" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="sendBroadcast()">üì¢ Send to All Users</button>
                        <button class="btn btn-warning" onclick="sendToActiveUsers()">üéØ Send to Active Users Only</button>
                    </div>
                </div>
            </div>

            <!-- Withdrawal Management -->
            <div class="section">
                <div class="section-title">üí≥ Withdrawal Management</div>
                
                <div id="withdrawalsList">
                    <p style="text-align: center; opacity: 0.7;">Click "Refresh Withdrawals" to load data</p>
                </div>

                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadPendingWithdrawals()">üîÑ Refresh Withdrawals</button>
                    <button class="btn btn-success" onclick="approveAllWithdrawals()">‚úÖ Approve All</button>
                    <button class="btn btn-danger" onclick="rejectAllWithdrawals()">‚ùå Reject All</button>
                </div>
            </div>

            <!-- Package Configuration -->
            <div class="section">
                <div class="section-title">üì¶ Package Configuration</div>
                
                <div id="packageConfig">
                    <p style="text-align: center; opacity: 0.7;">Loading packages...</p>
                </div>

                <div class="input-group">
                    <input type="text" class="form-input" id="newPackageName" placeholder="Package Name">
                    <input type="number" class="form-input" id="newPackagePrice" placeholder="Price ($)" step="0.01">
                    <input type="number" class="form-input" id="newPackageProfit" placeholder="Max Profit ($)" step="0.01">
                    <input type="number" class="form-input" id="newPackageTapLimit" placeholder="Daily Tap Limit">
                    <input type="number" class="form-input" id="newPackageTapValue" placeholder="Points per Tap" step="0.01">
                    <button class="btn btn-success" onclick="addNewPackage()">‚ûï Add Package</button>
                </div>
            </div>

            <!-- Database Status -->
            <div class="section">
                <div class="section-title">üìä Database Status</div>
                <div id="databaseStatus">
                    <p>üîÑ Checking connection...</p>
                </div>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="testConnection()">üß™ Test Connection</button>
                    <button class="btn btn-success" onclick="refreshAllData()">üîÑ Refresh All Data</button>
                    <button class="btn btn-warning" onclick="cleanupDatabase()">üßπ Cleanup Database</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• SUPABASE CREDENTIALS 
        const SUPABASE_URL = 'https://arjkzpbhinpqensoqqod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyamt6cGJoaW5wcWVuc29xcW9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwNjAwMTUsImV4cCI6MjA3MDYzNjAxNX0.zo5kS1J5Lv-FiRSJbt0hhaawUGB-6gNcZCgl74B7WBo';
        
        // Your Telegram ID
        const ADMIN_TELEGRAM_ID = 6733587823;
        
        // Bot token for broadcasting
        const BOT_TOKEN = '8105964064:AAE1rkye54RSBevmnYIIOBpCZnAkrMX-VsE';
        
        // Initialize Supabase client
        let supabase;
        let isSupabaseConnected = false;
        
        // Initialize Telegram Web App
        const tg = window.Telegram?.WebApp;
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeSupabase();
            
            if (tg) {
                tg.ready();
                checkAdminAccess();
            } else {
                // For testing without Telegram
                setTimeout(checkAdminAccess, 1000);
            }
        });

        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                isSupabaseConnected = true;
                console.log('‚úÖ Supabase connected successfully');
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                showDatabaseError(error.message);
            }
        }

        function showDatabaseError(error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('databaseError').style.display = 'block';
            document.getElementById('errorDetails').textContent = error;
        }

        function checkAdminAccess() {
            const loading = document.getElementById('loading');
            const accessDenied = document.getElementById('accessDenied');
            const adminPanel = document.getElementById('adminPanel');

            if (!isSupabaseConnected) {
                return;
            }

            // Get user data from Telegram
            const telegramUser = tg?.initDataUnsafe?.user;
            
            // For testing purposes (remove when deploying)
            const isAdmin = true; // Change this to: telegramUser && telegramUser.id === ADMIN_TELEGRAM_ID;

            setTimeout(() => {
                loading.style.display = 'none';
                
                if (isAdmin) {
                    adminPanel.style.display = 'block';
                    loadAdminData();
                } else {
                    accessDenied.style.display = 'block';
                }
            }, 1500);
        }

        async function loadAdminData() {
            try {
                await Promise.all([
                    loadStats(),
                    loadPackageConfig(),
                    loadPackageDropdown(),
                    testConnection()
                ]);
            } catch (error) {
                console.error('Error loading admin data:', error);
                showMessage('Failed to load admin data: ' + error.message, 'error');
            }
        }

        // FIXED: Proper way to load stats with correct Supabase count syntax
        async function loadStats() {
            try {
                // Get user count using the proper Supabase method
                const { count: userCount, error: countError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) throw countError;

                // Get users data for calculations
                const { data: users, error: usersError } = await supabase
                    .from('users')
                    .select('balance, total_taps, referral_count');
                
                if (usersError) throw usersError;

                // Get revenue from user_packages
                const { data: userPackages, error: packagesError } = await supabase
                    .from('user_packages')
                    .select(`
                        package_id,
                        is_active,
                        packages (price)
                    `);
                
                if (packagesError) throw packagesError;

                // Get withdrawals count
                const { count: withdrawalCount, error: withdrawalsError } = await supabase
                    .from('withdrawals')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'pending');
                
                if (withdrawalsError) throw withdrawalsError;

                // Update display
                document.getElementById('totalUsers').textContent = userCount || 0;
                
                const totalRevenue = userPackages?.reduce((sum, up) => sum + (up.packages?.price || 0), 0) || 0;
                document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
                
                const totalTaps = users?.reduce((sum, user) => sum + (user.total_taps || 0), 0) || 0;
                document.getElementById('totalTaps').textContent = totalTaps.toLocaleString();
                
                const activePackages = userPackages?.filter(up => up.is_active).length || 0;
                document.getElementById('activePackages').textContent = activePackages;
                
                document.getElementById('pendingWithdrawals').textContent = withdrawalCount || 0;
                
                const totalReferrals = users?.reduce((sum, user) => sum + (user.referral_count || 0), 0) || 0;
                document.getElementById('totalReferrals').textContent = totalReferrals;

            } catch (error) {
                console.error('Error loading stats:', error);
                showMessage('Failed to load statistics: ' + error.message, 'error');
            }
        }

        async function loadPackageDropdown() {
            try {
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('price', { ascending: true });
                
                if (error) throw error;

                const select = document.getElementById('packageSelect');
                select.innerHTML = '<option value="">Select Package...</option>';
                
                packages?.forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.id;
                    option.textContent = `${pkg.name} - $${pkg.price} (${pkg.tap_value} points/tap)`;
                    select.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading package dropdown:', error);
            }
        }

        // MANUAL PACKAGE ASSIGNMENT - This is the main feature you wanted!
        async function assignPackageToUser() {
            try {
                const userId = document.getElementById('packageUserId').value;
                const packageId = document.getElementById('packageSelect').value;
                const duration = document.getElementById('customDuration').value || 30;
                
                if (!userId || !packageId) {
                    showMessage('Please enter User ID and select a package!', 'error');
                    return;
                }

                showMessage('Assigning package...', 'info');

                // Check if user exists
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('telegram_id, username')
                    .eq('telegram_id', userId)
                    .single();

                if (userError || !user) {
                    throw new Error('User not found');
                }

                // Get package details
                const { data: packageData, error: packageError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (packageError || !packageData) {
                    throw new Error('Package not found');
                }

                // Deactivate existing active packages for this user
                await supabase
                    .from('user_packages')
                    .update({ is_active: false })
                    .eq('user_id', userId)
                    .eq('is_active', true);

                // Create new user_package entry
                const activationDate = new Date();
                const expirationDate = new Date();
                expirationDate.setDate(expirationDate.getDate() + parseInt(duration));

                const { error: insertError } = await supabase
                    .from('user_packages')
                    .insert({
                        user_id: userId,
                        package_id: packageId,
                        is_active: true,
                        activation_date: activationDate.toISOString(),
                        expiration_date: expirationDate.toISOString(),
                        earnings: 0,
                        taps_today: 0,
                        last_tap_reset: activationDate.toISOString()
                    });

                if (insertError) throw insertError;

                // Log the admin action
                await supabase
                    .from('admin_logs')
                    .insert({
                        admin_telegram_id: ADMIN_TELEGRAM_ID,
                        action: 'manual_package_assignment',
                        target_user_id: userId,
                        details: {
                            package_id: packageId,
                            package_name: packageData.name,
                            duration_days: duration,
                            activation_type: 'manual_admin'
                        }
                    });

                showMessage(`‚úÖ Package "${packageData.name}" assigned to ${user.username || userId} for ${duration} days!`, 'success');
                
                // Clear inputs
                document.getElementById('packageUserId').value = '';
                document.getElementById('packageSelect').value = '';
                document.getElementById('customDuration').value = '30';
                
                // Refresh data
                await loadStats();
                
            } catch (error) {
                console.error('Error assigning package:', error);
                showMessage('Failed to assign package: ' + error.message, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                showMessage('Loading users...', 'info');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select(`
                        *,
                        user_packages!user_packages_user_id_fkey (
                            is_active,
                            packages (name)
                        )
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;

                displayUsers(users || []);
                showMessage(`Loaded ${users?.length || 0} users`, 'success');
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Failed to load users: ' + error.message, 'error');
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px;">No users found</td></tr>';
                return;
            }

            users.forEach(user => {
                const activePackage = user.user_packages?.find(up => up.is_active);
                const packageName = activePackage?.packages?.name || 'None';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.telegram_id}</td>
                    <td>${user.username || 'N/A'}</td>
                    <td>${parseFloat(user.balance || 0).toFixed(2)}</td>
                    <td>${user.total_taps || 0}</td>
                    <td>${user.level || 1}</td>
                    <td>${user.referral_count || 0}</td>
                    <td><span style="color: ${activePackage ? '#ffd573' : '#999'}">${packageName}</span></td>
                    <td><span style="color: ${user.is_banned ? '#ff4757' : '#2ed573'}">${user.is_banned ? 'BANNED' : 'ACTIVE'}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewUserDetails(${user.telegram_id})">üëÅÔ∏è</button>
                        <button class="btn btn-warning" onclick="quickAssignPackage(${user.telegram_id})">üì¶</button>
                        <button class="
